# Документация к коду процессора

## Характеристики ##

+ В работе используется - ESP32-WROOM
+ Среда разработки - Arduino IDE 2.3.4 (требуется 1.8.10 и выше)
+ Используемая версия esp32 by Espressif Systems - 2.0.14
+ Board - ESP32 Dev Module
+ Port - COM7
+ Upload Speed - 912600 (в том числе и для Serial Monitor)
+ CPU Frequency - 240MHz (WI-FI/BT)
+ Библиотека - BluetoothSerial предустановленная в Arduino Core для ESP32
+ Схема системы для ленты - Schema1.jpg в этой же директории

## Ссылки ##

+ Arduino IDE - https://www.arduino.cc/en/software
+ Android Studio - https://developer.android.com/studio
+ Схема системы - https://github.com/EgorkaSQL/LED_strip/blob/main/for%20processor/Schema1.jpg

## Про код ##

Данный код позволяет управлять светодиодной лентой подключенной к ESP32-WROOM через BT. \
Управление осуществляется с помощью текстовых команд, которые включают режимы свечения ленты.\
Команды отправляются с помощью BT-терминала находящимся в устройстве - телефон.

## Код ##

### Функции ###

+ resetPins() - Функция для приведения диодов в изначальное состояние после отключения режимов/цветов
+ turnOnColor() - Функция, которая позволяет включить диоды с заданной яркостью. Использует PWM каналы чтобы плавно регулировать яркость (для слайдера)
+ setup() - Функция, которая устанавливает пины в OUTPUT и иинициализирует Bluetooth. Запускается перед началом работы, т.е отрабатывает тело 1 раз при включении.
+ loop() - Функция содержащая цикл. Она проверяет поступили ли команды через Bluetooth и выполняет действия в зависимости от команды

### Реализация ###

Для каждого из режимов или смены цветов предусмотрена своя команда, в ответ на которые запускается тело в котором меняется флаг режима.\
После этого выполняется сама реализация режима\
Ниже представлены режимы и их команды реагирования.

+ Синий цвет
  + On - M
  + Off - E
+ Красный цвет
  + On - Z
  + Off - X
+ Зеленый цвет
  + On - Q
  + Off - N
+ Синий и красный цвет
  + On - O
  + Off - R
+ Синий и зеленый цвет
  + On - 2
  + Off - V
+ Зеленый и красный цвет
  + On - b
  + Off - a
+ Blink
  + On - 3
  + Off - 4
+ Fade
  + On - 5
  + Off - 6
+ Phonk
  + On - 7
  + Off - 8
+ SOS
  + On - 9
  + Off - W
+ Flash
  + On - C
  + Off - D
+ Strobe
  + On - S
  + Off - A
+ Cold
  + On - G
  + Off - F
+ Romantic
  + On - J
  + Off - H
+ Relax
  + On - L
  + Off - K
+ Chill
  + On - 1
  + Off - P
+ Epileptics
  + On - U
  + Off - I
+ Police
  + On - T
  + Off - Y

Как можно заметить, то все команды - символы. Был выбран именно такой способ, поэтому из команд у нас было доступно символы a-z, A-Z, 0-9.

### Про реализацию ###

В основном каждая реализация режимов постоенна на циклах и изменении пина с INPUT н OUTPUT. Наши пины D14, D26, D33 имеют свойство быть как вход и как выход.\
На примере режима Blink объясню как именно работает эта система.

В коде явно можно наблюдать строку
> pinMode(PIN_B, OUTPUT);

Эта строчка выставляет пин Blue как выход, т.е подает туда напряжение и может как-то регулировать диод.

Для того чтобы процесс был безопасен нужно написать следующую строчку:
> digitalWrite(PIN_B, LOW)

Тем самым мы передаем сигнал с низким напряжением перед выставлением его в INPUT.

Выставляем пин в INPUT тем самым приглушая его свечение и не давая с ним работать
> pinMode(PIN_B, INPUT);

В то же время
> delay(int);

Позволяет делать паузу в мс, то есть в нашем случае мы выставляя 1000 делаем паузу в 1 секунду.

#### Теперь разберем работу с PWM ####

В нашем коде используется PWM для реализации затухания диодов, это так же работает и со слайдером яркости.\
На примере режима Fade разберем что именно происходит используя PWM.

> fadeDirection = fadeSpeed

Каждую итерацию цикла loop() значение яркости изменяется на величину.

Мы используем
> analogWrite(PIN_B, brightness);

Используя этот метод мы устанавливаем ШИМ-сигнал для изменения уровня яркости светодиодов.\
Этот метод позволяет задать яркость в диапазоне от 0 до 255.

В if мы прописываем, что когда яркость достигает максимального значения, либо же минимального, то изменяется направление на противоположное
> fadeDirection = -fadeDirection;

Далее мы выполняем паузу в незначительные 30мс
> delay(30)

## Заключение ##

Примерно так и работает код для ESP32. Сначала подключаемся к Bluetooth, после чего посылаем с устройста команды. В зависимоти от того какая команда пришла - выбирается режим и выполняет свою логику.
